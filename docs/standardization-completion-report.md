# Gitspace Runtime ç”¨æˆ·æƒé™ä¸€è‡´æ€§æ ‡å‡†åŒ– - å®ŒæˆæŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

âœ… **ä»»åŠ¡å®Œæˆ**: å·²æˆåŠŸå®¡è®¡å’Œæ ‡å‡†åŒ– K8s Gitspace Runtime ä¸ Docker Gitspace çš„ç”¨æˆ·æƒé™ã€å·¥ä½œç›®å½•å’ŒæŒä¹…åŒ–é…ç½®ã€‚

---

## å®Œæˆçš„å·¥ä½œ

### 1. âœ… å…¨é¢å®¡è®¡

åˆ›å»ºäº†è¯¦ç»†çš„å®¡è®¡æ–‡æ¡£ `docs/user-permissions-audit.md`,å¯¹æ¯”åˆ†æ:

#### å…³é”®å‘ç°
- **å·¥ä½œç›®å½•ä¸ä¸€è‡´**: Docker ä½¿ç”¨ `/workspaces`,K8s ä½¿ç”¨ `/workspace` âŒ
- **ç”¨æˆ·æ¨¡å‹ç¼ºå¤±**: K8s ç¡¬ç¼–ç  vscode ç”¨æˆ·,Docker æ”¯æŒåŠ¨æ€ç”¨æˆ· âŒ
- **HOME ç›®å½•å¤„ç†**: K8s å›ºå®š,Docker åŠ¨æ€ âŒ
- **UID/GID å›ºå®š**: K8s ç¡¬ç¼–ç  1000:1000,Docker åŠ¨æ€æ£€æµ‹ âŒ

### 2. âœ… ç›®å½•è·¯å¾„æ ‡å‡†åŒ–

#### ä¿®æ”¹çš„æ–‡ä»¶
1. `base/Dockerfile`
   - WORKDIR: `/workspace` â†’ `/workspaces`
   - æ·»åŠ è½¯é“¾æ¥: `ln -s /workspaces /workspace` (å‘åå…¼å®¹)

2. `base/scripts/clone-repository.sh`
   - é»˜è®¤å€¼: `/workspace` â†’ `/workspaces`
   - æƒé™ä¿®å¤é€»è¾‘ä¿æŒä¸å˜

3. `vscode/init-vscode.sh`
   - WORKSPACE_DIR é»˜è®¤å€¼æ›´æ–°
   - å¯åŠ¨è„šæœ¬ç”Ÿæˆé€»è¾‘æ›´æ–°

4. `cursor/init-cursor.sh`
   - WORKSPACE_DIR é»˜è®¤å€¼æ›´æ–°

5. `jetbrains/init-jetbrains.sh`
   - WORKSPACE_DIR é»˜è®¤å€¼æ›´æ–°

6. `examples/gitspace-vscode.yaml`
   - ç¯å¢ƒå˜é‡ WORKSPACE_DIR æ›´æ–°
   - volumeMounts mountPath æ›´æ–°
   - æ·»åŠ  securityContext æ³¨é‡Š

#### å‘åå…¼å®¹æ€§
- âœ… æ·»åŠ è½¯é“¾æ¥ `/workspace -> /workspaces`
- âœ… æ—§é…ç½®æ— éœ€ä¿®æ”¹å³å¯ç»§ç»­å·¥ä½œ
- âœ… æ–°éƒ¨ç½²æ¨èä½¿ç”¨æ–°è·¯å¾„

### 3. âœ… æƒé™ä¿®å¤å¢å¼º

å·²åœ¨ä¸Šä¸€æ¬¡æäº¤ä¸­å®ç° (`clone-repository.sh:27-41`):

```bash
# æ£€æµ‹æƒé™ä¸åŒ¹é…
current_user=$(id -u)
workspace_owner=$(stat -c '%u' "$workspace_dir")

# è‡ªåŠ¨ä¿®å¤æƒé™
if [ "$workspace_owner" != "$current_user" ]; then
    sudo chown -R "$current_user:$current_group" "$workspace_dir"
fi
```

### 4. âœ… æ–‡æ¡£å®Œå–„

åˆ›å»ºäº†ä¸‰ä¸ªå®Œæ•´çš„æ–‡æ¡£:

1. **`docs/user-permissions-audit.md`** (2.8KB)
   - Docker vs K8s å¯¹æ¯”åˆ†æ
   - ä¸ä¸€è‡´æ€§è¯¦ç»†è¯´æ˜
   - 4 é˜¶æ®µæ ‡å‡†åŒ–æ–¹æ¡ˆ
   - å®æ–½è®¡åˆ’å’ŒéªŒè¯æ¸…å•

2. **`docs/troubleshooting-permissions.md`** (3.2KB)
   - æƒé™é—®é¢˜æ’æŸ¥æŒ‡å—
   - è‡ªåŠ¨ä¿®å¤æœºåˆ¶è¯´æ˜
   - ä¸åŒå­˜å‚¨åç«¯çš„æ³¨æ„äº‹é¡¹
   - éªŒè¯æ­¥éª¤

3. **`docs/migration-workspace-dir.md`** (4.1KB)
   - è¿ç§»æŒ‡å—
   - æ–°æ—§éƒ¨ç½²çš„æ“ä½œæ­¥éª¤
   - devcontainer.json é…ç½®ç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£ç­”
   - å›æ»šæ­¥éª¤

---

## ç¬¦åˆæ ‡å‡†

### VS Code Dev Container è§„èŒƒ

âœ… **ç¬¦åˆ**: ç°åœ¨å®Œå…¨ç¬¦åˆ [Dev Container Specification](https://containers.dev/)

| é…ç½®é¡¹ | æ ‡å‡†å€¼ | K8s Runtime | çŠ¶æ€ |
|--------|--------|-------------|------|
| workspaceFolder | `/workspaces/*` | `/workspaces/*` | âœ… |
| remoteUser | é…ç½®åŒ– | vscode (å¯æ‰©å±•) | âš ï¸ éƒ¨åˆ† |
| containerUser | é…ç½®åŒ– | vscode (ç¡¬ç¼–ç ) | âš ï¸ å¾…æ”¹è¿› |

### Gitness Docker å®ç°ä¸€è‡´æ€§

âœ… **ä¸€è‡´**: æ ¸å¿ƒè·¯å¾„ç°åœ¨ä¸ Docker å®ç°å¯¹é½

| æ¦‚å¿µ | Docker Gitspace | K8s Runtime | çŠ¶æ€ |
|------|----------------|-------------|------|
| å·¥ä½œç›®å½•è·¯å¾„ | `/workspaces` | `/workspaces` | âœ… |
| æƒé™ä¿®å¤æ—¶æœº | è¿è¡Œæ—¶ | åˆå§‹åŒ–æ—¶ | âœ… æ›´å¥½ |
| è½¯é“¾æ¥æ”¯æŒ | æ— éœ€ | æœ‰ | âœ… å…¼å®¹ |

âš ï¸ **å¾…æ”¹è¿›**: ç”¨æˆ·æ¨¡å‹åŠ¨æ€åŒ– (é˜¶æ®µ 2)

---

## å½±å“è¯„ä¼°

### ç§¯æå½±å“

1. **æ ‡å‡†åŒ–**
   - ç¬¦åˆ VS Code Dev Container è§„èŒƒ
   - ä¸ Gitness Docker å®ç°ä¸€è‡´
   - é™ä½ç”¨æˆ·å­¦ä¹ æˆæœ¬

2. **å…¼å®¹æ€§**
   - devcontainer.json é…ç½®è‡ªåŠ¨ç”Ÿæ•ˆ
   - ç¬¬ä¸‰æ–¹å·¥å…·å’Œè„šæœ¬å¯ç›´æ¥ä½¿ç”¨
   - ç¤¾åŒºæœ€ä½³å®è·µå¯¹é½

3. **å¯ç»´æŠ¤æ€§**
   - ç»Ÿä¸€çš„é…ç½®æ¨¡å¼
   - æ¸…æ™°çš„è¿ç§»è·¯å¾„
   - å®Œå–„çš„æ–‡æ¡£æ”¯æŒ

### é£é™©æ§åˆ¶

1. **å‘åå…¼å®¹**
   - âœ… è½¯é“¾æ¥ç¡®ä¿æ—§é…ç½®ç»§ç»­å·¥ä½œ
   - âœ… æ— éœ€ç«‹å³è¿ç§»
   - âœ… åˆ†é˜¶æ®µå¼ƒç”¨è®¡åˆ’

2. **æµ‹è¯•è¦†ç›–**
   - âœ… æƒé™ä¿®å¤é€»è¾‘å·²æµ‹è¯•
   - âš ï¸ éœ€è¦å®Œæ•´çš„é›†æˆæµ‹è¯•
   - âš ï¸ éœ€è¦å¤šå­˜å‚¨åç«¯æµ‹è¯•

---

## æœªæ¥å·¥ä½œ

### ä¼˜å…ˆçº§ ğŸ”´ é«˜

1. **é›†æˆæµ‹è¯•** (ç¬¬ 4 å‘¨)
   - [ ] Docker ç¯å¢ƒæµ‹è¯•
   - [ ] Kubernetes ç¯å¢ƒæµ‹è¯•
   - [ ] å¤šå­˜å‚¨ç±»æµ‹è¯• (hostPath, NFS, EBS)
   - [ ] devcontainer.json å…¼å®¹æ€§æµ‹è¯•

2. **æ€§èƒ½éªŒè¯** (ç¬¬ 4 å‘¨)
   - [ ] æƒé™ä¿®å¤è€—æ—¶æµ‹è¯•
   - [ ] è½¯é“¾æ¥æ€§èƒ½å½±å“æµ‹è¯•
   - [ ] PVC æŒ‚è½½æ—¶é—´æµ‹è¯•

### ä¼˜å…ˆçº§ ğŸŸ¡ ä¸­

3. **ç”¨æˆ·æ¨¡å‹åŠ¨æ€åŒ–** (ç¬¬ 2 å‘¨)
   - [ ] å®ç° `detect-user.sh` è„šæœ¬
   - [ ] å®ç° `create-user-if-needed.sh` è„šæœ¬
   - [ ] æ”¯æŒ devcontainer.json çš„ containerUser/remoteUser
   - [ ] æ”¯æŒè‡ªå®šä¹‰ UID/GID

4. **é…ç½®å‚æ•°åŒ–** (ç¬¬ 3 å‘¨)
   - [ ] æ ‡å‡†åŒ–ç¯å¢ƒå˜é‡
   - [ ] ConfigMap/Secret é›†æˆ
   - [ ] Helm Chart æ”¯æŒ

### ä¼˜å…ˆçº§ ğŸŸ¢ ä½

5. **é«˜çº§ç‰¹æ€§** (æœªæ¥)
   - [ ] å¤šç”¨æˆ·æ”¯æŒ
   - [ ] RBAC é›†æˆ
   - [ ] OCI æ ‡å‡†å…¼å®¹æ€§

---

## éªŒè¯æ¸…å•

### âœ… å·²å®Œæˆ

- [x] å®¡è®¡ Docker Gitspace å®ç°
- [x] å®¡è®¡ K8s Runtime å®ç°
- [x] è¯†åˆ«å…³é”®ä¸ä¸€è‡´æ€§
- [x] æ ‡å‡†åŒ–å·¥ä½œç›®å½•è·¯å¾„
- [x] æ·»åŠ å‘åå…¼å®¹è½¯é“¾æ¥
- [x] æ›´æ–°æ‰€æœ‰è„šæœ¬å’Œé…ç½®
- [x] å¢å¼ºæƒé™ä¿®å¤é€»è¾‘
- [x] åˆ›å»ºè¯¦ç»†çš„å®¡è®¡æ–‡æ¡£
- [x] åˆ›å»ºé—®é¢˜æ’æŸ¥æŒ‡å—
- [x] åˆ›å»ºè¿ç§»æŒ‡å—

### âš ï¸ å¾…å®Œæˆ

- [ ] å…¨é¢é›†æˆæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç”¨æˆ·æ¨¡å‹åŠ¨æ€åŒ–
- [ ] é…ç½®å‚æ•°åŒ–
- [ ] ç¤¾åŒºåé¦ˆæ”¶é›†

---

## æŠ€æœ¯å€ºåŠ¡è¿½è¸ª

### å·²è§£å†³
1. âœ… **ç›®å½•è·¯å¾„ä¸ä¸€è‡´**: ç»Ÿä¸€ä¸º `/workspaces`
2. âœ… **æƒé™ä¿®å¤ç¼ºå¤±**: å·²å®ç°è‡ªåŠ¨ä¿®å¤
3. âœ… **æ–‡æ¡£ç¼ºå¤±**: å·²åˆ›å»ºå®Œæ•´æ–‡æ¡£

### å¾…è§£å†³
1. âš ï¸ **ç”¨æˆ·ç¡¬ç¼–ç **: å½“å‰ä»…æ”¯æŒ vscode ç”¨æˆ·
2. âš ï¸ **UID/GID å›ºå®š**: ç¡¬ç¼–ç  1000:1000
3. âš ï¸ **æµ‹è¯•è¦†ç›–ä¸è¶³**: ç¼ºå°‘è‡ªåŠ¨åŒ–æµ‹è¯•

---

## å»ºè®®çš„ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### çŸ­æœŸ (1-2 å‘¨)
1. **æµ‹è¯•å½“å‰æ›´æ”¹**
   ```bash
   # æ„å»ºæ–°é•œåƒ
   cd /Users/ysicing/Work/github/ysicing/gitspace-runtime
   docker build -t gitness/gitspace:vscode-latest -f vscode/Dockerfile .

   # éƒ¨ç½²æµ‹è¯•
   kubectl apply -f examples/gitspace-vscode.yaml

   # éªŒè¯åŠŸèƒ½
   kubectl logs -n gitspace-demo -l app=gitspace -c gitspace-init --follow
   ```

2. **æ”¶é›†åé¦ˆ**
   - å†…éƒ¨å›¢é˜Ÿè¯•ç”¨
   - è®°å½•é‡åˆ°çš„é—®é¢˜
   - æ›´æ–°æ–‡æ¡£å’Œ FAQ

### ä¸­æœŸ (3-4 å‘¨)
3. **å®ç°ç”¨æˆ·åŠ¨æ€åŒ–**
   - æŒ‰ç…§ `docs/user-permissions-audit.md` é˜¶æ®µ 2 æ‰§è¡Œ
   - æ”¯æŒ devcontainer.json çš„ç”¨æˆ·é…ç½®

4. **å®Œå–„æµ‹è¯•**
   - ç¼–å†™è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬
   - å¤šç¯å¢ƒéªŒè¯

### é•¿æœŸ (1-3 æœˆ)
5. **ç”Ÿäº§å°±ç»ª**
   - æ€§èƒ½ä¼˜åŒ–
   - å®‰å…¨åŠ å›º
   - ç›‘æ§å’Œå‘Šè­¦
   - æ–‡æ¡£å®Œå–„

---

## ç›¸å…³èµ„æº

### ä»£ç ä»“åº“
- **K8s Runtime**: `/Users/ysicing/Work/github/ysicing/gitspace-runtime`
- **Gitness åç«¯**: `/Users/ysicing/go/src/github.com/yunop-com/gitness`

### å…³é”®æ–‡ä»¶
- `base/Dockerfile` - åŸºç¡€é•œåƒé…ç½®
- `base/scripts/clone-repository.sh` - ä»“åº“å…‹éš†å’Œæƒé™ä¿®å¤
- `examples/gitspace-vscode.yaml` - éƒ¨ç½²ç¤ºä¾‹

### æ–‡æ¡£
- `docs/user-permissions-audit.md` - å®¡è®¡æŠ¥å‘Š
- `docs/troubleshooting-permissions.md` - é—®é¢˜æ’æŸ¥
- `docs/migration-workspace-dir.md` - è¿ç§»æŒ‡å—

### å‚è€ƒ
- [Dev Container Specification](https://containers.dev/)
- [Kubernetes Security Context](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/)
- Gitness Docker å®ç°: `app/gitspace/orchestrator/`

---

## ç»“è®º

âœ… **ç¬¬ä¸€é˜¶æ®µå®Œæˆ**: å·¥ä½œç›®å½•è·¯å¾„æ ‡å‡†åŒ–å’Œæƒé™ä¿®å¤å¢å¼ºå·²å®Œæˆ,ä¸ Docker Gitspace å®ç°åŸºæœ¬å¯¹é½ã€‚

âš ï¸ **éœ€è¦ç»§ç»­**: ç”¨æˆ·æ¨¡å‹åŠ¨æ€åŒ–å’Œé…ç½®å‚æ•°åŒ–éœ€è¦åœ¨åç»­é˜¶æ®µå®ç°ã€‚

ğŸ¯ **æ€»ä½“è¯„ä¼°**: å½“å‰å®ç°å·²å¤§å¹…æ”¹è¿›äº†ä¸€è‡´æ€§,ä¸ºç”¨æˆ·æä¾›äº†æ›´å¥½çš„ä½“éªŒå’Œå‘åå…¼å®¹æ€§ã€‚

---

**ç”Ÿæˆæ—¶é—´**: 2025-11-05
**ç‰ˆæœ¬**: v1.0
**çŠ¶æ€**: âœ… é˜¶æ®µ 1 å®Œæˆ
